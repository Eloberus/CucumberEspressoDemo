language: android
android:
  components:
    - build-tools-27.0.3
    - android-26
#emulator dependencies
    - android-22
    - sys-img-armeabi-v7a-android-22

jobs:
  include:
    - stage: unit-test
      script:
        - ./gradlew test
    - stage: emulator-ui-test
      script:
        - echo no | android create avd --force -n test -t android-22 --abi armeabi-v7a
        - emulator -avd test -no-audio -no-window &
        - android-wait-for-emulator
        - adb shell input keyevent 82 &
        - ./gradlew build connectedCheck

    - stage: firebase-ui-test
      script:
      #setup gcloud
        - gc_sdk_url=$(curl -s "https://cloud.google.com/sdk/downloads?hl=de" | grep -o "https.*google-cloud-sdk.*linux.*x86_64.*\\.tar\\.gz" | sed s/\\?.*//g)
        - wget -qO- ${gc_sdk_url} | tar xvz

      # gcloud login
        - echo ${GOOGLE_AUTH} | base64 --decode > ${HOME}/gcp-key.json
        - ./google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/gcp-key.json
        - ./google-cloud-sdk/bin/gcloud --quiet config set project ${PROJECT_ID}
        - ./gradlew assembleAndroidTest assemble
        - APK_PATH=$(find . -path "*.apk" ! -path "*unaligned.apk" ! -path "*Test*.apk" -print -quit)
        - TEST_APK_PATH=$(find "." "-path" "*Test*.apk" -print -quit)
        - ./google-cloud-sdk/bin/gcloud firebase test android run --type instrumentation --app ${APK_PATH} --test ${TEST_APK_PATH} --device model=sailfish,version=27,locale=en,orientation=portrait --timeout 30m

stages:
  - unit-test
  - emulator-ui-test
    if:
      - type IN (pull_request)
      - branch = master
  - firebase-ui-test
    if:
      - type IN (push)
      - branch = master